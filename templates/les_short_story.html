<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
        href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/static/css/les_short_story.css">
    <!-- <link rel="stylesheet" href="/static/css/responsive.css"> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <title>Lesson</title>
</head>

<body>
    <div class="nav">
        <div class="logo">
            <h4>TheraTalk</h4>
        </div>
        <div class="mid">
            <a href="/patient/" id="home">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            <a href="/patient/mission" id="mission">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</a>
        </div>
        <div class="las">
            <a href="/patient/profile">
                <i class="fa-solid fa-user"></i>
            </a>
            <a href="/logout">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </a>
        </div>
    </div>
    <div class="container">
        <div class="fori">
            <a href="javascript:window.history.back()"><i class="fa-solid fa-chevron-left"></i></a>
        </div>
        <div class="main">
            <div class="bar">
                <h2>{{ story_data.title }}</h2>
                <div class="listen-box">
                    <i class="fa-solid fa-volume-high" id="play-sound-btn"></i>
                </div>
            </div>
            <div class="exercise-box">
                {% for q_index in range(story_data.questions | length) %}
                    {% set q = story_data.questions[q_index] %}
                    <div class="question-block">
                        <p>{{ q.q }}</p>
                        <div class="choice">
                            {% for c_index in range(q.choice | length) %}
                                <input type="radio" name="ans_{{ q_index }}" id="choice{{ q_index }}_{{ c_index }}">
                                <label for="choice{{ q_index }}_{{ c_index }}">{{ q.choice[c_index] }}</label>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="check-btn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
        </div>
    </div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const playButton = document.getElementById("play-sound-btn");
        const checkBtn = document.getElementById("check-btn");

        // story_data is passed from backend as JSON
        const storyData = {{ story_data | tojson }};
        const storyText = storyData.story;
        const questions = storyData.questions;

        const pathParts = window.location.pathname.split('/');
        const activityid = parseInt(pathParts[pathParts.length - 1]);

        const urlParams = new URLSearchParams(window.location.search);
        const assignmentid = parseInt(urlParams.get("assignment_id"));
        const templateid = parseInt(urlParams.get("templateid"));

        let cachedAudio = null;

        // üîÅ Fetch audio on page load
        try {
            const response = await fetch("/api/tts/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ text: storyText }),
            });

            if (!response.ok) throw new Error("Failed to fetch audio");

            const data = await response.json();
            const audioUrl = data.audio_url;

            cachedAudio = new Audio(audioUrl);
        } catch (error) {
            console.error("Error fetching audio on load:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
        }

        playButton.addEventListener("click", () => {
            if (cachedAudio) {
                cachedAudio.currentTime = 0;
                cachedAudio.play();
            } else {
                alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ");
            }
        });

        checkBtn.addEventListener("click", async () => {
            let correct = 0;
            let total = questions.length;
            const wrongAttempts = {};
            let feedback = "";

            questions.forEach((q, qIndex) => {
                const selected = document.querySelector(`input[name="ans_${qIndex}"]:checked`);
                if (selected) {
                    const selectedLabel = document.querySelector(`label[for="${selected.id}"]`);
                    const selectedText = selectedLabel.textContent.trim();

                    if (selectedText === q.ans) {
                        correct++;
                        feedback += `‡∏Ç‡πâ‡∏≠ ${qIndex + 1}: ‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n`;
                    } else {
                        feedback += `‡∏Ç‡πâ‡∏≠ ${qIndex + 1}: ‚ùå ‡∏ú‡∏¥‡∏î‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n`;
                        wrongAttempts[q.q] = 1;
                    }
                } else {
                    feedback += `‡∏Ç‡πâ‡∏≠ ${qIndex + 1}: ‚ùó ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö\n`;
                    wrongAttempts[q.q] = 1;
                }
            });

            // ‚úÖ If all correct ‚Üí send to backend
            if (correct === total) {
                try {
                    const res = await fetch("/patient/finish/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            completed: true,
                            wrong_summary: wrongAttempts,
                            activityid: activityid,
                            templateid: templateid,
                            assignmentid: assignmentid,
                        }),
                    });

                    if (!res.ok) {
                        throw new Error("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    }
                } catch (err) {
                    console.error("Error sending:", err);
                    Swal.fire({
                        icon: "error",
                        title: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
                        text: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà",
                        confirmButtonText: "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
                    });
                }
                window.location.href = "/patient/";
            } else {
                // ‚ùå Show feedback in alert if any wrong
                Swal.fire({
                    icon: 'warning',
                    title: `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÑ‡∏î‡πâ ${correct}/${total} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`,
                    html: feedback.replace(/\n/g, '<br>'),
                    confirmButtonText: '‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                });
            }
        });


    });
</script>
</html>